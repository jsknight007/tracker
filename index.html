<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pillar Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 1.5rem;
      background: #f0f2f5;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    }
    h1 { margin-bottom: 1.5rem; color: #1a73e8; font-size: 1.5rem; text-align: center; }

    /* Config Section */
    .config-section {
      background: #fff9c4;
      border: 1px solid #fbc02d;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
    .config-section input { width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; }
    .config-section button { width: 100%; padding: 0.5rem; background: #fbc02d; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

    /* Tabs */
    .input-tabs { display: flex; gap: 10px; margin-bottom: 1rem; }
    .tab-button { flex: 1; padding: 0.8rem; background: #e4e6eb; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .tab-button.active { background: #1a73e8; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Buttons */
    #mic {
      width: 100%; padding: 2.5rem; font-size: 1.2rem; border: none; background: #34a853; color: white; border-radius: 12px; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; gap: 12px;
    }
    #mic.listening { background: #ea4335; animation: pulse 1.5s infinite; }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(234, 67, 53, 0.4); }
      70% { transform: scale(0.98); box-shadow: 0 0 0 20px rgba(234, 67, 53, 0); }
      100% { transform: scale(1); }
    }

    .manual-input-container { display: flex; gap: 0.5rem; }
    #manualInput { flex: 1; padding: 1rem; border: 2px solid #e4e6eb; border-radius: 10px; font-size: 1rem; outline: none; }
    #manualInput:focus { border-color: #1a73e8; }
    #submitBtn { padding: 0 1.2rem; background: #1a73e8; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.2rem; }

    .quick-examples { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 8px; }
    .example-chip { padding: 0.5rem 0.9rem; background: #e8f0fe; border: 1px solid #d2e3fc; border-radius: 20px; font-size: 0.85rem; color: #1967d2; cursor: pointer; }

    .transcript-container { margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-left: 5px solid #1a73e8; min-height: 60px; border-radius: 8px; font-style: italic; color: #3c4043; }
    #status { margin-top: 1rem; padding: 0.8rem; border-radius: 8px; display: none; text-align: center; font-weight: 500; }
    .success { background: #e6f4ea; color: #137333; display: block !important; }
    .error { background: #fce8e6; color: #c5221f; display: block !important; }
    .sending { background: #e8f0fe; color: #1967d2; display: block !important; }

    /* History & Reconciliation */
    .history-section { margin-top: 1.5rem; }
    .history-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .history-item strong { display: block; font-size: 1rem; }
    .history-item small { color: #70757a; }
  </style>
</head>
<body>

  <div class="container">
    <h1>üí≥ Pillar Tracker</h1>

    <div class="config-section">
      <h3>Google Apps Script URL</h3>
      <input type="text" id="urlInput" placeholder="https://script.google.com/macros/s/.../exec">
      <button onclick="updateURL()">Save & Connect</button>
    </div>

    <div class="input-tabs">
      <button id="voiceTabBtn" class="tab-button active" onclick="switchTab('voice')">üéôÔ∏è Voice</button>
      <button id="manualTabBtn" class="tab-button" onclick="switchTab('manual')">‚å®Ô∏è Manual</button>
    </div>

    <div id="voiceTab" class="tab-content active">
      <button id="mic">
        <span id="micIcon" style="font-size: 2.5rem;">üéôÔ∏è</span>
        <span id="micText">Tap to Speak</span>
      </button>
    </div>

    <div id="manualTab" class="tab-content">
      <div class="manual-input-container">
        <input type="text" id="manualInput" placeholder="Store Price Card Date">
        <button id="submitBtn">üì§</button>
      </div>
      <div class="quick-examples">
        <div class="example-chip" onclick="fillExample('Panera $14.82 Citi today')">Citi</div>
        <div class="example-chip" onclick="fillExample('Target $87 Discover yesterday')">Discover</div>
        <div class="example-chip" onclick="fillExample('Gas $45 GreenState')">GreenState</div>
        <div class="example-chip" onclick="fillExample('Costco $150 Costco')">Costco</div>
        <div class="example-chip" onclick="fillExample('Verizon $120 Verizon')">Verizon</div>
      </div>
    </div>

    <div class="transcript-container" id="transcript">Ready for input...</div>
    <div id="status"></div>

    <button id="deleteLastBtn" onclick="deleteLast()" style="width:100%; margin-top:10px; padding:0.6rem; background:#fee; color:#c5221f; border:1px solid #fadad7; border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight: 600;">
      Oops! Delete Last Entry
    </button>

    <hr style="margin: 2rem 0; border: 0; border-top: 1px solid #ddd;">

    <div class="history-section">
      <h3>Recent History</h3>
      <div style="display: flex; gap: 8px; margin-top: 0.5rem; margin-bottom: 1rem;">
        <select id="cardFilter" style="flex: 1; padding: 0.6rem; border-radius: 8px; border: 1px solid #ddd;">
          <option value="Citi">Citi</option>
          <option value="GreenState">GreenState</option>
          <option value="Discover">Discover</option>
          <option value="Costco">Costco</option>
          <option value="Verizon">Verizon</option>
        </select>
        <button onclick="fetchHistory()" style="padding: 0.5rem 1rem; background: #1a73e8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">View</button>
      </div>
      <div id="historyList" style="font-size: 0.85rem; max-height: 300px; overflow-y: auto; border: 1px solid #f0f2f5; border-radius: 8px;"></div>
    </div>
  </div>

  <script>
    const CONFIG = {
      WEB_APP_URL: localStorage.getItem('WEB_APP_URL') || "",
    };

    const elements = {
      mic: document.getElementById("mic"),
      micText: document.getElementById("micText"),
      manualInput: document.getElementById("manualInput"),
      submitBtn: document.getElementById("submitBtn"),
      transcript: document.getElementById("transcript"),
      status: document.getElementById("status"),
      urlInput: document.getElementById("urlInput"),
      historyList: document.getElementById("historyList")
    };

    if (CONFIG.WEB_APP_URL) elements.urlInput.value = CONFIG.WEB_APP_URL;

    // UI Tab Logic
    function switchTab(tab) {
      document.getElementById('voiceTab').classList.toggle('active', tab === 'voice');
      document.getElementById('manualTab').classList.toggle('active', tab === 'manual');
      document.getElementById('voiceTabBtn').classList.toggle('active', tab === 'voice');
      document.getElementById('manualTabBtn').classList.toggle('active', tab === 'manual');
    }

    function fillExample(val) {
      elements.manualInput.value = val;
      elements.manualInput.focus();
    }

    function updateURL() {
      const url = elements.urlInput.value.trim();
      if (url.includes('script.google.com')) {
        CONFIG.WEB_APP_URL = url;
        localStorage.setItem('WEB_APP_URL', url);
        showStatus("‚úÖ Connected", "success");
      } else { alert("Invalid URL"); }
    }

    function showStatus(msg, type) {
      elements.status.textContent = msg;
      elements.status.className = type;
      if (type !== 'sending') setTimeout(() => elements.status.className = '', 4000);
    }

    // Submission Logic
    async function submitExpense(command) {
      if (!CONFIG.WEB_APP_URL) return showStatus("‚ö†Ô∏è Save URL first", "error");
      showStatus("üì§ Logging...", "sending");
      try {
        const formData = new URLSearchParams();
        formData.append('command', command);
        await fetch(CONFIG.WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData.toString()
        });
        showStatus("‚úÖ Saved!", "success");
        elements.manualInput.value = "";
      } catch (err) { showStatus("‚ùå Error: " + err.message, "error"); }
    }

    // ENTER KEY FIX
    elements.manualInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        elements.submitBtn.click();
      }
    });

    elements.submitBtn.onclick = () => {
      const val = elements.manualInput.value.trim();
      if (val) {
        elements.transcript.textContent = `"${val}"`;
        submitExpense(val);
      }
    };

    // Voice Engine
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      elements.mic.onclick = () => {
        recognition.start();
        elements.mic.classList.add('listening');
        elements.micText.textContent = "Recording...";
      };
      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        elements.transcript.textContent = `"${text}"`;
        submitExpense(text);
      };
      recognition.onend = () => {
        elements.mic.classList.remove('listening');
        elements.micText.textContent = "Tap to Speak";
      };
    }

    // History & Delete Functions
    async function deleteLast() {
      if (!confirm("Delete the absolute last entry in the sheet?")) return;
      try {
        const res = await fetch(`${CONFIG.WEB_APP_URL}?action=deleteLast`);
        const data = await res.json();
        if (data.success) { showStatus("üóëÔ∏è Deleted Last", "success"); fetchHistory(); }
      } catch (e) { alert("Delete failed"); }
    }

    async function fetchHistory() {
      const card = document.getElementById('cardFilter').value;
      if (!CONFIG.WEB_APP_URL) return;
      elements.historyList.innerHTML = "<p style='padding:10px'>‚åõ Loading...</p>";
      try {
        const res = await fetch(`${CONFIG.WEB_APP_URL}?card=${card}`);
        const data = await res.json();
        if (data.entries && data.entries.length > 0) {
          elements.historyList.innerHTML = data.entries.map(e => `
            <div class="history-item">
              <span><strong>${e.where}</strong> ($${parseFloat(e.price).toFixed(2)})<br><small>${e.when}</small></span>
              <button onclick="reconcileItem(${e.index})" style="background:#e6f4ea; border:none; padding:10px; border-radius:50%; cursor:pointer; font-size:1.2rem;">‚úÖ</button>
            </div>
          `).join('');
        } else { elements.historyList.innerHTML = "<p style='padding:10px'>No entries found.</p>"; }
      } catch (e) { elements.historyList.innerHTML = "<p style='padding:10px'>Error loading history.</p>"; }
    }

    async function reconcileItem(index) {
      if (!confirm("Reconcile (delete) this item?")) return;
      try {
        const res = await fetch(`${CONFIG.WEB_APP_URL}?action=deleteSpecific&index=${index}`);
        const data = await res.json();
        if (data.success) fetchHistory();
      } catch (e) { alert("Reconcile failed"); }
    }
  </script>
</body>
</html>