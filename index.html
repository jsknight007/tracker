<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 1.5rem; background: #f0f2f5; }
    .container { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); }
    h1 { margin-bottom: 1.5rem; color: #1a73e8; font-size: 1.5rem; text-align: center; }
    
    .config-section { background: #fff9c4; border: 1px solid #fbc02d; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
    .config-section input { width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; }
    .config-section button { width: 100%; padding: 0.5rem; background: #fbc02d; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    
    .input-tabs { display: flex; gap: 10px; margin-bottom: 1rem; }
    .tab-button { flex: 1; padding: 0.8rem; background: #e4e6eb; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .tab-button.active { background: #1a73e8; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    #mic { width: 100%; padding: 2.5rem; font-size: 1.2rem; border: none; background: #34a853; color: white; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 12px; }
    #mic.listening { background: #ea4335; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 70% { transform: scale(0.98); } 100% { transform: scale(1); } }

    .manual-input-container { display: flex; gap: 0.5rem; }
    #manualInput { flex: 1; padding: 1rem; border: 2px solid #e4e6eb; border-radius: 10px; font-size: 1rem; outline: none; }
    #submitBtn { padding: 0 1.2rem; background: #1a73e8; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.2rem; }
    .example-chip { padding: 0.5rem 0.9rem; background: #e8f0fe; border: 1px solid #d2e3fc; border-radius: 20px; font-size: 0.85rem; color: #1967d2; cursor: pointer; margin: 4px; display: inline-block; }
    
    .transcript-container { margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-left: 5px solid #1a73e8; min-height: 60px; border-radius: 8px; font-style: italic; }
    #status { margin-top: 1rem; padding: 0.8rem; border-radius: 8px; display: none; text-align: center; font-weight: 500; }
    .success { background: #e6f4ea; color: #137333; display: block !important; }
    .error { background: #fce8e6; color: #c5221f; display: block !important; }
    .sending { background: #e8f0fe; color: #1967d2; display: block !important; }
    .history-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>

  <div class="container">
    <h1>üí≥ Expense Tracker</h1>

    <div class="config-section">
      <input type="text" id="urlInput" placeholder="Google Script URL">
      <button onclick="updateURL()">Save URL</button>
    </div>

    <div class="input-tabs">
      <button id="manualTabBtn" class="tab-button active" onclick="switchTab('manual')">‚å®Ô∏è Manual</button>
      <button id="voiceTabBtn" class="tab-button" onclick="switchTab('voice')">üéôÔ∏è Voice</button>
    </div>

    <div id="manualTab" class="tab-content active">
      <div class="manual-input-container">
        <input type="text" id="manualInput" placeholder="Store Price Card Date">
        <button id="submitBtn">üì§</button>
      </div>
      <div style="margin-top: 1rem;">
        <div class="example-chip" onclick="fill('Citi')">Citi</div>
        <div class="example-chip" onclick="fill('Discover')">Discover</div>
        <div class="example-chip" onclick="fill('GreenState')">GreenState</div>
        <div class="example-chip" onclick="fill('Costco')">Costco</div>
        <div class="example-chip" onclick="fill('Other')">Other</div>
      </div>
    </div>

    <div id="voiceTab" class="tab-content">
      <button id="mic">
        <span id="micIcon" style="font-size: 2.5rem;">üéôÔ∏è</span>
        <span id="micText">Tap to Speak</span>
      </button>
    </div>

    <div class="transcript-container" id="transcript">Waiting for input...</div>
    <div id="status"></div>

    <button onclick="deleteLast()" style="width:100%; margin-top:10px; padding:0.6rem; background:#fee; color:#c5221f; border:1px solid #fadad7; border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight:600;">
      Oops! Delete Last Entry
    </button>

    <hr style="margin: 2rem 0; border: 0; border-top: 1px solid #ddd;">

    <h3>Reconcile</h3>
    <div style="display: flex; gap: 8px; margin-top: 0.5rem; margin-bottom: 1rem;">
      <select id="cardFilter" style="flex: 1; padding: 0.6rem; border-radius: 8px; border: 1px solid #ddd;">
        <option value="Citi">Citi</option>
        <option value="GreenState">GreenState</option>
        <option value="Discover">Discover</option>
        <option value="Costco">Costco</option>
        <option value="Verizon">Verizon</option>
        <option value="Other">Other</option>
      </select>
      <button onclick="fetchHistory()" style="padding: 0.5rem 1rem; background: #1a73e8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">View</button>
    </div>
    <div id="historyList" style="font-size: 0.85rem; max-height: 250px; overflow-y: auto; border: 1px solid #f0f2f5; border-radius: 8px;"></div>

    <div style="text-align: center; margin-top: 2rem; font-size: 0.7rem; color: #bdc3c7;">v1.2.0</div>
  </div>

  <script>
    const CONFIG = { WEB_APP_URL: localStorage.getItem('WEB_APP_URL') || "" };
    const elements = {
      mic: document.getElementById("mic"),
      micText: document.getElementById("micText"),
      manualInput: document.getElementById("manualInput"),
      submitBtn: document.getElementById("submitBtn"),
      transcript: document.getElementById("transcript"),
      status: document.getElementById("status"),
      urlInput: document.getElementById("urlInput"),
      historyList: document.getElementById("historyList")
    };

    if (CONFIG.WEB_APP_URL) elements.urlInput.value = CONFIG.WEB_APP_URL;

    function switchTab(tab) {
      document.getElementById('voiceTab').classList.toggle('active', tab === 'voice');
      document.getElementById('manualTab').classList.toggle('active', tab === 'manual');
      document.getElementById('voiceTabBtn').classList.toggle('active', tab === 'voice');
      document.getElementById('manualTabBtn').classList.toggle('active', tab === 'manual');
    }

    function fill(val) { elements.manualInput.value += " " + val; elements.manualInput.focus(); }

    function updateURL() {
      const url = elements.urlInput.value.trim();
      if (url.includes('script.google.com')) {
        CONFIG.WEB_APP_URL = url;
        localStorage.setItem('WEB_APP_URL', url);
        showStatus("‚úÖ Saved", "success");
      }
    }

    function showStatus(msg, type) {
      elements.status.textContent = msg;
      elements.status.className = type;
      if (type !== 'sending') setTimeout(() => elements.status.className = '', 4000);
    }

    async function submitExpense(command) {
      if (!CONFIG.WEB_APP_URL) return showStatus("‚ö†Ô∏è URL missing", "error");
      showStatus("üì§ Logging...", "sending");
      try {
        await fetch(CONFIG.WEB_APP_URL, {
          method: "POST", mode: "no-cors",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ 'command': command })
        });
        showStatus("‚úÖ Saved!", "success");
        elements.manualInput.value = "";
      } catch (err) { showStatus("‚ùå Error", "error"); }
    }

    // ENTER KEY
    elements.manualInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") { e.preventDefault(); elements.submitBtn.click(); }
    });

    elements.submitBtn.onclick = () => {
      const val = elements.manualInput.value.trim();
      if (val) { elements.transcript.textContent = `"${val}"`; submitExpense(val); }
    };

    // Voice
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      elements.mic.onclick = () => { recognition.start(); elements.mic.classList.add('listening'); elements.micText.textContent = "Listening..."; };
      recognition.onresult = (e) => { const text = e.results[0][0].transcript; elements.transcript.textContent = `"${text}"`; submitExpense(text); };
      recognition.onend = () => { elements.mic.classList.remove('listening'); elements.micText.textContent = "Tap to Speak"; };
    }

    async function deleteLast() {
      if (!confirm("Delete last?")) return;
      await fetch(`${CONFIG.WEB_APP_URL}?action=deleteLast`);
      showStatus("üóëÔ∏è Deleted", "success");
      fetchHistory();
    }

    async function fetchHistory() {
      const card = document.getElementById('cardFilter').value;
      elements.historyList.innerHTML = "<p style='padding:10px'>Loading...</p>";
      const res = await fetch(`${CONFIG.WEB_APP_URL}?card=${card}`);
      const data = await res.json();
      if (data.entries && data.entries.length > 0) {
        elements.historyList.innerHTML = data.entries.map(e => `
          <div class="history-item">
            <span><strong>${e.where}</strong> ($${parseFloat(e.price).toFixed(2)})<br><small>${e.when}</small></span>
            <button onclick="reconcileItem(${e.index})" style="background:#e6f4ea; border:none; padding:10px; border-radius:50%; cursor:pointer;">‚úÖ</button>
          </div>
        `).join('');
      } else { elements.historyList.innerHTML = "<p style='padding:10px'>No entries.</p>"; }
    }

    async function reconcileItem(index) {
      if (!confirm("Reconcile?")) return;
      await fetch(`${CONFIG.WEB_APP_URL}?action=deleteSpecific&index=${index}`);
      fetchHistory();
    }
  </script>
</body>
</html>
