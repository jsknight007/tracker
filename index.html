<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Expense Tracker Admin</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 1rem; background: #f0f2f5; color: #1c1e21; }
    .container { background: white; padding: 1.25rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); width: 100%; overflow: hidden; }
    h1 { margin-bottom: 1.25rem; color: #1a73e8; font-size: 1.4rem; text-align: center; font-weight: 800; }
    .input-tabs { display: flex; gap: 8px; margin-bottom: 1.25rem; background: #f0f2f5; padding: 4px; border-radius: 12px; }
    .tab-button { flex: 1; padding: 0.75rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; color: #65676b; background: transparent; }
    .tab-button.active { background: white; color: #1a73e8; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .manual-input-container { display: flex; gap: 0.6rem; width: 100%; align-items: center; }
    #manualInput { flex: 1; min-width: 0; padding: 1rem; border: 2px solid #e4e6eb; border-radius: 12px; font-size: 1rem; outline: none; transition: border-color 0.2s; }
    #manualInput:focus { border-color: #1a73e8; }
    #submitBtn { width: 54px; height: 54px; background: #1a73e8; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    #submitBtn:active { transform: scale(0.92); background: #1557b0; }
    .example-chip { padding: 0.5rem 0.8rem; background: #e8f0fe; border: 1px solid #d2e3fc; border-radius: 12px; font-size: 0.8rem; color: #1967d2; cursor: pointer; margin: 4px 2px; display: inline-block; transition: all 0.1s; }
    .example-chip:active { background: #d2e3fc; transform: translateY(1px); }
    #mic { width: 100%; padding: 2.5rem; font-size: 1.2rem; border: none; background: #34a853; color: white; border-radius: 16px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 12px; box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3); }
    #mic.listening { background: #ea4335; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(0.97); } 100% { transform: scale(1); } }
    .transcript-container { margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-left: 4px solid #1a73e8; min-height: 50px; border-radius: 8px; font-style: italic; font-size: 0.9rem; }
    #status { margin-top: 1rem; padding: 0.8rem; border-radius: 10px; display: none; text-align: center; font-weight: 600; font-size: 0.9rem; }
    .success { background: #e6f4ea; color: #137333; display: block !important; }
    .error { background: #fce8e6; color: #c5221f; display: block !important; }
    .sending { background: #e8f0fe; color: #1967d2; display: block !important; }
    .history-card { margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1.5rem; }
    .history-item { padding: 12px 0; border-bottom: 1px solid #f0f2f5; display: flex; justify-content: space-between; align-items: center; }
    .history-details { display: flex; flex-direction: column; }
    .history-price { font-weight: 700; color: #1c1e21; }
    .btn-delete { width: 100%; margin-top: 12px; padding: 0.8rem; background: #fff5f5; color: #c5221f; border: 1px solid #ffdada; border-radius: 12px; font-size: 0.85rem; cursor: pointer; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí≥ Expense Admin</h1>

    <div class="input-tabs">
      <button id="manualTabBtn" class="tab-button active" onclick="switchTab('manual')">‚å®Ô∏è Manual</button>
      <button id="voiceTabBtn" class="tab-button" onclick="switchTab('voice')">üéôÔ∏è Voice</button>
    </div>

    <div id="manualTab" class="tab-content active">
      <div class="manual-input-container">
        <input type="text" id="manualInput" placeholder="Store Price Card Date" spellcheck="false" autocomplete="off">
        <button id="submitBtn">üì§</button>
      </div>
      <div style="margin-top: 1rem; text-align: center;">
        <div class="example-chip" onclick="fill('Citi')">Citi</div>
        <div class="example-chip" onclick="fill('Discover')">Discover</div>
        <div class="example-chip" onclick="fill('GreenState')">GreenState</div>
        <div class="example-chip" onclick="fill('Costco')">Costco</div>
        <div class="example-chip" onclick="fill('Yesterday')">Yesterday</div>
      </div>
    </div>

    <div id="voiceTab" class="tab-content">
      <button id="mic"><span id="micIcon" style="font-size: 2.5rem;">üéôÔ∏è</span><span id="micText">Tap to Speak</span></button>
    </div>

    <div class="transcript-container" id="transcript">Ready for entry...</div>
    <div id="status"></div>

    <button onclick="deleteLast()" class="btn-delete">Delete Last Entry</button>

    <div class="history-card">
      <h3 style="font-size: 1rem; margin-bottom: 0.8rem;">Reconcile Records</h3>
      <div style="display: flex; gap: 8px; margin-bottom: 1rem;">
        <select id="cardFilter" style="flex: 1; padding: 0.75rem; border-radius: 10px; border: 1px solid #e4e6eb; background: white; font-size: 0.9rem;">
          <option value="Citi">Citi</option>
          <option value="GreenState">GreenState</option>
          <option value="Discover">Discover</option>
          <option value="Costco">Costco</option>
          <option value="Verizon">Verizon</option>
          <option value="Other">Other</option>
        </select>
        <button onclick="fetchHistory()" style="padding: 0.75rem 1.25rem; background: #1a73e8; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">View</button>
      </div>
      <div id="historyList"></div>
    </div>
    <div style="text-align: center; margin-top: 2rem; font-size: 0.65rem; color: #bdc3c7;">V1.4.0 ‚Ä¢ STABLE</div>
  </div>

  <script>
    // PASTE YOUR URL HERE
    const CONFIG = { WEB_APP_URL: "https://script.google.com/macros/s/AKfycbxy2OhLXzjmz1JJLU6RgCzKUP78WL4jJ29tQNX6l3AhgIousJKZ7WwbAvXrpiZkHOKc/exec" };
    
    const elements = {
      mic: document.getElementById("mic"),
      micText: document.getElementById("micText"),
      manualInput: document.getElementById("manualInput"),
      submitBtn: document.getElementById("submitBtn"),
      transcript: document.getElementById("transcript"),
      status: document.getElementById("status"),
      historyList: document.getElementById("historyList")
    };

    function switchTab(tab) {
      document.getElementById('voiceTab').classList.toggle('active', tab === 'voice');
      document.getElementById('manualTab').classList.toggle('active', tab === 'manual');
      document.getElementById('voiceTabBtn').classList.toggle('active', tab === 'voice');
      document.getElementById('manualTabBtn').classList.toggle('active', tab === 'manual');
    }

    function fill(val) { elements.manualInput.value += (elements.manualInput.value ? " " : "") + val; elements.manualInput.focus(); }

    function showStatus(msg, type) {
      elements.status.textContent = msg;
      elements.status.className = type;
      if (type !== 'sending') setTimeout(() => elements.status.className = '', 4000);
    }

    async function submitExpense(command) {
      showStatus("üì§ Sending...", "sending");
      try {
        await fetch(CONFIG.WEB_APP_URL, {
          method: "POST", mode: "no-cors",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ 'command': command })
        });
        showStatus("‚úÖ Saved", "success");
        elements.manualInput.value = "";
      } catch (err) { showStatus("‚ùå Error", "error"); }
    }

    elements.manualInput.addEventListener("keypress", (e) => { if (e.key === "Enter") elements.submitBtn.click(); });
    elements.submitBtn.onclick = () => { if (elements.manualInput.value.trim()) submitExpense(elements.manualInput.value.trim()); };

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      elements.mic.onclick = () => { recognition.start(); elements.mic.classList.add('listening'); elements.micText.textContent = "Listening..."; };
      recognition.onresult = (e) => { const text = e.results[0][0].transcript; elements.transcript.textContent = `"${text}"`; submitExpense(text); };
      recognition.onend = () => { elements.mic.classList.remove('listening'); elements.micText.textContent = "Tap to Speak"; };
    }

    async function deleteLast() {
      if (confirm("Delete last entry?")) {
        await fetch(`${CONFIG.WEB_APP_URL}?action=deleteLast`);
        showStatus("üóëÔ∏è Deleted", "success");
      }
    }

    async function fetchHistory() {
      const card = document.getElementById('cardFilter').value;
      elements.historyList.innerHTML = "<p style='padding:10px; font-size:0.8rem;'>Loading...</p>";
      const res = await fetch(`${CONFIG.WEB_APP_URL}?card=${card}`);
      const data = await res.json();
      if (data.entries && data.entries.length > 0) {
        elements.historyList.innerHTML = data.entries.map(e => `
          <div class="history-item">
            <div class="history-details"><strong>${e.where}</strong><small>${e.when}</small></div>
            <div style="display:flex; align-items:center; gap:10px;">
              <span class="history-price">$${parseFloat(e.price).toFixed(2)}</span>
              <button onclick="reconcileItem(${e.index})" style="background:#e6f4ea; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer;">‚úÖ</button>
            </div>
          </div>
        `).join('');
      } else { elements.historyList.innerHTML = "<p style='padding:10px;'>Empty.</p>"; }
    }

    async function reconcileItem(index) {
      if (confirm("Reconcile?")) {
        await fetch(`${CONFIG.WEB_APP_URL}?action=deleteSpecific&index=${index}`);
        fetchHistory();
      }
    }
  </script>
</body>
</html>
